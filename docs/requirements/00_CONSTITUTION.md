# 要件定義書（憲法）— 非交渉事項（Constitution）

## 1. 本プロジェクトの「100%精度」の定義
本システムの「精度」は、占いの的中率ではない。
**入力（出生情報＋設定）に対し、命式（4柱＋派生要素）を決定論的に算出し、Golden Data と一致させること**をもって「100%精度」と定義する。

## 2. 用語
- Golden Data：権威ある資料（万年暦・師伝等）から作成した正解データ。回帰テストの唯一の基準。
- ルール差分（流派差）：日替わり時刻、子刻解釈、真太陽時採用、南半球モード等の差。**必ず設定化**する。

## 3. 非交渉事項（Non‑Negotiables）
### 3.1 天文学・時間系
N-01 節入り（算命学で使う12節）を近似式で求めない（高精度天文計算で"瞬間"を特定する）。
N-02 時柱は「時計時刻」ではなく、原則「真太陽時（経度補正＋均時差）」で判定できる設計とする。
N-03 日柱は JDN/JD 等の連続日数で決定し、暦の不連続（改暦等）に耐える。

### 3.2 算命学ロジック
N-04 子刻・日替わり（0:00/23:00）・晩子時/早子時などは**設定化**し、ハードコードしない。
N-05 蔵干の主導気（初/中/本）は固定日数で区切らない。
     「節間の総実時間」を比率（例：7:7:16）で按分し、境界時刻を決定する。
N-06 十大主星は 10×10 のルックアップテーブル（定数マトリクス）で決定する（if-else羅列禁止）。
N-07 十二大従星は 10×12 の対照表で決定し、星ごとの点数テーブルも保持する。

### 3.3 品質・運用
N-08 変更のたびに Golden 回帰テストを実行し、精度を壊さない（CI必須ゲート）。
N-09 出力には再現性メタ（engine_version / schema_version / config_hash / tables_version / flags）を含める。
N-10 出生情報は機微データとして扱い、最小化・暗号化・監査ログを必須とする。
N-11 天文暦等の外部ライブラリのライセンスを遵守する（商用形態に応じて法務確認）。

## 4. CIゲート（必須順）
G-01 Goldenケース品質検証：`python scripts/validate_golden.py`
G-02 Golden回帰：`pytest -q tests/golden`
（推奨）G-00 テーブル検証：`python scripts/validate_tables.py --strict`

## 5. 変更管理
- 仕様変更は要件ID/仕様IDを更新する
- Golden expected の変更は原則禁止（根拠ある資料に基づく改訂のみ例外）
