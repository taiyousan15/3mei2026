# 要件定義書（全文・人間用）

## 1. 背景
算命学の命式計算は、節入り境界・子刻境界などにより不連続に結果が変わる。
一般的な簡易計算は、節入り近似、均時差/経度補正の省略等により境界付近で誤りが生じ得る。
本プロジェクトは、天文学的に厳密な命式算出を実装し、Golden Dataで100%一致を保証する。

## 2. 目的
- 入力（出生情報＋設定）から命式を決定論的に算出する
- Golden Dataと100%一致をCIで担保し、精度を維持する
- Next.js 15で入力→計算→閲覧→保存→共有を提供する
- 本番はGoogle Cloudで運用可能な構成とする

## 3. ステークホルダー
- 一般ユーザー：命式の作成・閲覧・保存・共有
- 鑑定士/研究者：設定切替、デバッグ情報、根拠の追跡
- 管理者：プリセット/テーブル管理、監査ログ
- 開発者：Claude Codeでの高速開発、Goldenで品質維持
- 法務/セキュリティ：個人情報、ライセンス、監査

## 4. スコープ
### 4.1 In Scope（初期）
- 入力：出生日時（ローカルISO）、TZ（IANA）、緯度経度
- 設定：プリセット選択＋上書き（config_overrides）
- 算出：
  - 4柱（年/月/日/時）
  - 月蔵干：主導気（初/中/本）＋主導干
  - 十大主星：10×10テーブル参照
  - 十二大従星：10×12テーブル参照＋点数
- 表示：4柱、蔵干、主星、従星、点数、再現性メタ
- 保存：履歴、再取得
- 共有：最小（共有リンク or JSONエクスポート）
- 監査：計算/保存/共有/管理更新の最小ログ

### 4.2 Out of Scope（初期）
- 鑑定文（文章生成）
- 位相法（支合/冲/刑等）の網羅
- 住所→緯度経度の自動ジオコーディング（拡張で対応）
- 旧暦入力の完全対応（拡張で対応）

## 5. ユースケース
UC-01 ユーザーが出生情報を入力し命式を計算して閲覧する
UC-02 ユーザーが設定プリセットを切り替え、結果差分を確認する
UC-03 ユーザーが結果を保存し、後日再閲覧する
UC-04 ユーザーが共有リンク/JSONで共有する（権限制御）
UC-05 管理者がテーブル/プリセットを更新し、監査ログを確認する

## 6. 機能要件（FR）
FR-01 出生情報入力（ISO日時/TZ/緯度経度）
FR-02 設定プリセット選択、設定上書き
FR-03 命式計算（4柱）
FR-04 蔵干（主導気 初/中/本＋主導干）
FR-05 十大主星（10×10テーブル）
FR-06 十二大従星（10×12テーブル＋点数）
FR-07 結果表示（再現性メタ含む）
FR-08 デバッグ表示（節入り、JD/JDN、真太陽時補正、設定、フラグ）
FR-09 保存（DB）と履歴表示
FR-10 共有（最小）
FR-11 監査ログ
FR-12 管理機能（プリセット/テーブル管理）

## 7. 非機能要件（NFR）
NFR-01 精度：Golden Dataと100%一致
NFR-02 再現性：同一入力＋同一設定＋同一バージョン＝同一出力
NFR-03 性能：計算API p95 < 1.5秒（初期目標）
NFR-04 可用性：月次 99.9%（初期目標、SLOは運用で調整）
NFR-05 セキュリティ：最小権限、暗号化、監査、秘密管理
NFR-06 監視：ログ/メトリクス/アラート
NFR-07 互換性：schema_versionで互換管理（破壊変更はversionを上げる）

## 8. 受入基準（AC）
AC-01 CIでGolden回帰（全件）がパス
AC-02 境界ケース（節入り±数分、子刻境界）をGoldenに含める
AC-03 保存→再取得で再現性メタが一致
AC-04 GCPでデプロイ/ロールバック可能
AC-05 個人情報の取扱いが文書化され実装へ反映

## 9. リスクと対策（抜粋）
R-01 ライセンス：天文暦ライブラリの商用条件 → 早期に法務確認
R-02 境界バグ：1分差で命式が変化 → Goldenを境界中心に増やす
R-03 TZ/DST：歴史的変更 → 入力ポリシー/例外処理を明文化
R-04 個人情報：漏えいリスク → 暗号化/アクセス制御/監査ログ
